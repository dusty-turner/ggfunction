---
title: "Survival Analysis with ggfunction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Survival Analysis with ggfunction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.height = 4
)
library(ggfunction)
library(patchwork)
```

## Introduction

In survival analysis, the time until an event of interest (failure, death,
relapse, etc.) is described by four interrelated functions:

- **Density** $f(x)$: the instantaneous rate of events at time $x$.
- **Survival function** $S(x) = 1 - F(x) = P(T > x)$: the probability of
  surviving past time $x$.
- **Hazard function** $h(x) = f(x) / S(x)$: the instantaneous failure rate at
  time $x$, conditional on survival to that point.
- **Cumulative hazard function** $H(x) = \int_0^x h(t)\,dt = -\log S(x)$: the
  accumulated hazard up to time $x$.

These four functions are equivalent representations of the same distribution:
knowing any one determines the other three. **ggfunction** provides geoms for
all four, both for theoretical distributions and for empirical data.


## Theoretical survival curves

`geom_survival()` draws $S(x) = 1 - F(x)$ from a CDF or survival function.
Different distributions encode different assumptions about the failure
mechanism.

```{r survival-curves}
ggplot() +
  geom_survival(cdf_fun = pexp,   xlim = c(0, 6), args = list(rate = 1),
                colour = "steelblue") +
  geom_survival(cdf_fun = pweibull, xlim = c(0, 6),
                args = list(shape = 2, scale = 2), colour = "firebrick") +
  geom_survival(cdf_fun = pnorm, xlim = c(-3, 6),
                args = list(mean = 3, sd = 1), colour = "forestgreen") +
  labs(x = "Time", y = "S(x)",
       title = "Survival functions for three distributions") +
  theme_minimal()
```

The exponential survival curve (blue) decays at a constant rate---the memoryless
property. The Weibull (red) decays faster over time (increasing hazard), while
the normal (green) concentrates failures around the mean.


## Hazard functions

The hazard function $h(x) = f(x) / S(x)$ reveals the instantaneous risk of
failure at each time point. Its shape is a signature of the underlying failure
mechanism.

```{r hazard-shapes}
ggplot() +
  geom_hf(pdf_fun = dexp, cdf_fun = pexp, xlim = c(0.01, 6),
          args = list(rate = 1), colour = "steelblue") +
  geom_hf(pdf_fun = dweibull, cdf_fun = pweibull, xlim = c(0.01, 6),
          args = list(shape = 2, scale = 2), colour = "firebrick") +
  geom_hf(pdf_fun = dweibull, cdf_fun = pweibull, xlim = c(0.01, 6),
          args = list(shape = 0.5, scale = 2), colour = "forestgreen") +
  labs(x = "Time", y = "h(x)",
       title = "Three canonical hazard shapes") +
  theme_minimal()
```

The three canonical shapes are: **constant** (exponential, blue---no aging),
**increasing** (Weibull with shape > 1, red---wear-out failures), and
**decreasing** (Weibull with shape < 1, green---infant mortality). Real-world
systems often exhibit a "bathtub curve" that combines all three phases.


## Cumulative hazard functions

The cumulative hazard $H(x) = -\log S(x)$ accumulates the instantaneous hazard
over time. A linear cumulative hazard corresponds to a constant hazard rate
(exponential distribution).

```{r chf-curves}
ggplot() +
  geom_chf(cdf_fun = pexp, xlim = c(0, 6), args = list(rate = 1),
           colour = "steelblue") +
  geom_chf(cdf_fun = pweibull, xlim = c(0, 6),
           args = list(shape = 2, scale = 2), colour = "firebrick") +
  geom_chf(cdf_fun = pweibull, xlim = c(0, 6),
           args = list(shape = 0.5, scale = 2), colour = "forestgreen") +
  labs(x = "Time", y = "H(x)",
       title = "Cumulative hazard functions") +
  theme_minimal()
```

The exponential cumulative hazard (blue) is a straight line with slope equal to
the rate parameter. The Weibull with increasing hazard (red) curves upward,
while the decreasing-hazard Weibull (green) curves downward.


## The full picture

The four functions together provide a complete characterization of a
distribution. Here we display all four for a Weibull(2, 2) distribution.

```{r four-panel, fig.width = 8, fig.height = 6}
args_w <- list(shape = 2, scale = 2)
xl <- c(0.01, 6)

p_pdf <- ggplot() +
  geom_pdf(fun = dweibull, xlim = xl, args = args_w) +
  labs(x = "x", y = "f(x)", title = "Density") +
  theme_minimal()

p_surv <- ggplot() +
  geom_survival(cdf_fun = pweibull, xlim = xl, args = args_w) +
  labs(x = "x", y = "S(x)", title = "Survival") +
  theme_minimal()

p_haz <- ggplot() +
  geom_hf(pdf_fun = dweibull, cdf_fun = pweibull, xlim = xl, args = args_w) +
  labs(x = "x", y = "h(x)", title = "Hazard") +
  theme_minimal()

p_chf <- ggplot() +
  geom_chf(cdf_fun = pweibull, xlim = xl, args = args_w) +
  labs(x = "x", y = "H(x)", title = "Cumulative hazard") +
  theme_minimal()

(p_pdf | p_surv) / (p_haz | p_chf)
```


## Empirical cumulative hazard

When working with observed data, `geom_echf()` computes the empirical cumulative
hazard function by transforming the empirical CDF:

$$\hat{H}_n(x) = -\log(1 - \hat{F}_n(x)).$$

The final observation, where $\hat{F}_n(x) = 1$ and $\hat{H}_n = \infty$, is
automatically dropped, and the step function extends to the right panel edge at
the last finite value.

A simultaneous confidence band is derived by applying the monotone
transformation $H = -\log(1 - F)$ to the DKW bounds on the CDF. Since the DKW
inequality guarantees

$$P\!\left(\sup_x |\hat{F}_n(x) - F(x)| \leq \varepsilon\right) \geq 1 - \alpha,$$

the transformed band $[-\log(1 - (\hat{F}_n(x) - \varepsilon)),\; -\log(1 -
(\hat{F}_n(x) + \varepsilon))]$ covers the true $H(x)$ simultaneously at all
$x$ with the same probability.

```{r echf-basic}
set.seed(42)
df <- data.frame(x = rexp(50, rate = 0.5))

ggplot(df, aes(x = x)) +
  geom_echf() +
  labs(x = "Time", y = expression(hat(H)[n](x)),
       title = "Empirical cumulative hazard (Exp(0.5) data)") +
  theme_minimal()
```


## Comparing theory to data

Overlaying `geom_chf()` on `geom_echf()` provides a visual goodness-of-fit
check: if the theoretical cumulative hazard lies within the confidence band, the
data are consistent with the model.

```{r gof-check}
set.seed(42)
df <- data.frame(x = rexp(80, rate = 0.5))

ggplot(df, aes(x = x)) +
  geom_echf(show_points = FALSE, show_vert = FALSE) +
  geom_chf(cdf_fun = pexp, xlim = c(0, max(df$x)),
           args = list(rate = 0.5), colour = "red") +
  labs(x = "Time", y = "H(x)",
       title = "Empirical CHF vs. Exp(0.5) theory") +
  theme_minimal()
```

The theoretical line (red) threads through the confidence band, confirming that
the data are consistent with an $\text{Exp}(0.5)$ model. For the exponential
distribution, the cumulative hazard is linear: $H(x) = \lambda x$, so this plot
is analogous to a log-survival plot where a straight line confirms exponentiality.


## Multiple groups

`geom_echf()` supports grouped data via the `colour` aesthetic, enabling
side-by-side comparison of cumulative hazard patterns between populations.

```{r two-group}
set.seed(7)
df_groups <- data.frame(
  x     = c(rexp(60, rate = 1), rexp(60, rate = 0.3)),
  group = rep(c("High risk (rate=1)", "Low risk (rate=0.3)"), each = 60)
)

ggplot(df_groups, aes(x = x, colour = group)) +
  geom_echf(show_points = FALSE, show_vert = FALSE) +
  labs(x = "Time", y = expression(hat(H)[n](x)),
       colour = NULL,
       title = "Comparing cumulative hazard across groups") +
  theme_minimal()
```

The high-risk group's cumulative hazard rises steeply, while the low-risk
group's rises more gradually. The non-overlapping confidence bands provide
visual evidence that the two groups have different hazard profiles.
